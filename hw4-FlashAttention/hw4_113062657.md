---
title: PP HW4 Report

---

# <center>PP HW4 Report</center> <div style="text-align: right; font-size: 16px;">113062657 é»ƒç››æš</div>
## 1.	**Implementation**

### a. Describe how you implemented the FlashAttention forward pass using CUDA. Mention the algorithm's key steps, such as matrix blocking, SRAM usage, and how intermediate results like scaling factors (â„“ and ğ‘š) were calculated.
* **Matrix Blocking** : å°‡ ğ‘„ Qã€ ğ¾ Kã€ ğ‘‰ V çŸ©é™£åˆ†å‰²ç‚ºè¼ƒå°çš„å€å¡Šï¼Œé€™æ¨£å¯ä»¥åœ¨shared memory ä¸­è™•ç†ã€‚ æ¯æ¬¡åªéœ€åŠ è¼‰å€å¡Šåˆ°shared memoryä¸­ï¼Œæ¸›å°‘å°global memoryçš„é »ç¹è¨ªå•ã€‚ 

* **SRAM Usage** : ä½¿ç”¨å…±äº«è¨˜æ†¶é«”å„²å­˜ ğ‘„ã€ ğ¾ã€ ğ‘‰ çš„å€å¡ŠåŠIntermediate Resultsï¼Œå¦‚scaling factors â„“ å’Œ ğ‘šã€‚ è—‰ç”±åˆ†å¡Šè™•ç†æ¸›å°‘global memory bandwidthçš„éœ€æ±‚ï¼Œæå‡è³‡æ–™å­˜å–æ•ˆç‡ã€‚
 
* **Intermediate Results** : åœ¨ CUDA kernelä¸­dynamicallyè¨ˆç®—scaling factors â„“ï¼ˆç´¯ç©çš„è¡Œç¸½å’Œï¼‰å’Œ ğ‘šï¼ˆæ¯è¡Œçš„æœ€å¤§å€¼ï¼‰ï¼Œç¢ºä¿ softmax è¨ˆç®—çš„æ•¸å€¼çš„æ­£ç¢ºæ€§ã€‚

---

### b.Explain how matrices Q, K, and V are divided into blocks and processed in parallel.

* **Block Division** : 
    * Q çš„æ¯å€‹blockåŒ…å« 32 è¡Œå’Œ ğ‘‘ åˆ—ã€‚ 
    * ğ¾ çš„æ¯å€‹blockåŒ…å« ğ‘‘ è¡Œå’Œ 32 åˆ—ã€‚ 
    * ğ‘‰ çš„æ¯å€‹blockåŒ…å« 32 è¡Œå’Œ ğ‘‘ åˆ—ã€‚
* **Parallel Processing** :
    *  åœ¨æ¯å€‹ thread block ä¸­ï¼Œ 32 Ã— 32 = 1024 å€‹ threads å”ä½œå®Œæˆå°æ‡‰å€å¡Šçš„è¨ˆç®—ä»»å‹™ã€‚ 
    *  æ¯å€‹ thread è¨ˆç®— $ğ‘† = ğ‘„ â‹… ğ¾ ^ âŠ¤$ çŸ©é™£ä¸­çš„ç‰¹å®šå…ƒç´ ä¾†å®Œæˆ softmaxã€‚

---

### c.Describe how you chose the block sizes B_r and B_c and why.
ç”±æ–¼threadsçš„æ•¸é‡ä¸Šé™ç‚º1024ä¸”32 æ˜¯ CUDA warp çš„å¤§å°æ‰€ä»¥B_rè·ŸB_céƒ½ç‚º32ã€‚

---

### d.Specify the configurations for CUDA kernel launches, such as the number of threads per block, shared memory allocation, and grid dimensions.
* æ¯å€‹ thread block çš„ thread æ•¸: æ¯å€‹blockå•Ÿå‹• 32 Ã— 32 çš„ threadã€‚
* shared memory allocation: ä½¿ç”¨shared memoryå„²å­˜ ğ‘„ ã€ ğ¾ ã€ ğ‘‰  çš„å€å¡Šï¼Œä»¥åŠæš«å­˜ç”¨çš„ â„“ å’Œ ğ‘šï¼Œè€Œç”±æ–¼ d = {32 , 64}ï¼Œæ•…  ğ‘‚ ã€ ğ‘„ ã€ ğ¾ ã€ ğ‘‰ ç›´æ¥é–‹BLOCK_SIZE * 64çš„å¤§å°å°±å¯ä»¥ä¸ç”¨extern memoryå®Œæˆå®£å‘Š
* grid dimensions: Grid = ( N / BLOCK_SIZE )çš„ç¶­åº¦æœƒè¦†è“‹ ğ‘„ ã€ ğ¾  çš„æ‰€æœ‰å€å¡Šï¼Œç¢ºä¿æ•´å€‹çŸ©é™£èƒ½ä¸¦è¡Œé‹ç®—ã€‚

---

### e.Justify your choices and how they relate to the blocking factors and the SRAM size.
* 32 Ã— 32 çš„blockç¢ºä¿shared memoryçš„ä½¿ç”¨é‡ç¬¦åˆ GPU ç¡¬é«”é™åˆ¶ã€‚
* Blockingé™ä½äº†è¨˜æ†¶é«”latencyï¼Œä¸¦æœ€å¤§åŒ–è¨˜æ†¶é«”bandwidthçš„ä½¿ç”¨æ•ˆç‡ã€‚

---


## 2. **Profiling Results**
ç‚ºè·‘t20çš„çµæœã€‚

| Metric                            | Minimum       | Maximum       | Average       |
|---------------------------------------|---------------|---------------|---------------|
| Achieved Occupancy                    | 0.499931      | 0.499944      | 0.499936      |
| Multiprocessor Activity               | 80.43%        | 81.68%        | 81.24%        |
| Shared Memory Load Throughput         | 2074.1GB/s    | 2142.6GB/s    | 2100.8GB/s    |
| Shared Memory Store Throughput        | 97.428GB/s    | 100.65GB/s    | 98.685GB/s    |
| Global Load Throughput                | 221.70GB/s    | 229.03GB/s    | 224.56GB/s    |
| Global Store Throughput               | 221.21MB/s    | 228.52MB/s    | 224.07MB/s    |


---

## 3. **Experiment & Analysis**
### a. System Spec
* Apollo GPU
* ä½¿ç”¨t20åšå¯¦é©—

---

### b. Optimization

![output (3)](https://hackmd.io/_uploads/rybCIRrBJg.png)

ä¸€é–‹å§‹åŠ©æ•™çµ¦å¾—code`seq-flashattention`çš„runtimeç‚º219ç§’ï¼Œç„¶å¾Œç”¨cudaå¹³è¡Œï¼Œä¸¦çµ±ä¸€ä½¿ç”¨ä¸€å€‹kernel functionï¼Œå…¶é¤˜çš„é‹ç®—æ”¹ç”¨__device__ functionï¼Œå¯ä»¥å°‡æ‰€æœ‰è¦ä½¿ç”¨çš„è®Šæ•¸ç§»åˆ°shared memoryä¸­ï¼Œä¸¦ä¸”H2Dè·ŸD2Hçš„æ¬ç§»åœ¨åŒä¸€å€‹batchä¸‹åªéœ€å…©æ¬¡ï¼Œæ¸›å°‘memory copyè·Ÿå¤§å¹…å¢åŠ shared memoryçš„ä½¿ç”¨ï¼Œæ™‚é–“ä¾†åˆ°1.3ç§’ã€‚
åœ¨è·‘äº†`nvprof --metrics shared_store_transactions_per_request`çš„æƒ…æ³ä¸‹å¯ä»¥ç™¼ç¾load çš„æ™‚å€™ average bank conflict Per Requestç‚º8.5æ¬¡ï¼Œæ‰€ä»¥ç”¨paddingçš„æ–¹å¼è§£æ±ºbank conflictï¼Œæ™‚é–“é™åˆ°0.62ç§’ã€‚

---

### c. Other
<div style="display: flex; justify-content: center;">
  <img src="https://hackmd.io/_uploads/BJOEkyLHke.png" width="400">
</div>

æœ‰åšå„é …çš„time distributionï¼Œå¯ä»¥ç™¼ç¾ç”±æ–¼data sizeå¾ˆå¤§`memcpy()`ä½”äº†å¾ˆå¤§çš„æ¯”ä¾‹ï¼Œä¹Ÿé–“æ¥è¡¨ç¾å‡ºFlashAttentionå¹³è¡Œçš„çµæœé‚„ä¸éŒ¯ã€‚

---

## 4. **Experience & conclusion**

æœ¬æ¬¡çš„bank conflictæ¯”èµ·hw3ä¾†èªªå¤šäº†å¾ˆå¤šï¼Œåœ¨å„ªåŒ–ä¸Šé€²æ­¥çš„ä¹Ÿæ˜é¡¯ã€‚ç„¶å¾Œæœ¬æ¬¡çš„sequential codeå°æˆ‘å€‘å¹³è¡Œçš„å¹«åŠ©éå¸¸å¤§ï¼Œæ¯”èµ·hw3åœ¨å¯¦ä½œä¸Šå®¹æ˜“å¾ˆå¤šã€‚
